{"version":3,"sources":["../../../../../lib/xlsx/xform/sheet/data-validations-xform.js"],"names":["_","require","utils","BaseXform","assign","definedName","attributes","name","defaultValue","value","undefined","parseBool","assignBool","DataValidationsXform","xmlStream","model","count","Object","keys","length","openNode","each","address","type","addAttribute","operator","allowBlank","showInputMessage","promptTitle","prompt","showErrorMessage","errorStyle","errorTitle","error","formulae","forEach","formula","index","writeText","dateToExcel","closeNode","node","_address","sqref","_definedName","_formula","text","push","join","parseInt","parseFloat","excelToDate","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,CAAC,GAAGC,OAAO,CAAC,2BAAD,CAAjB;;AACA,IAAMC,KAAK,GAAGD,OAAO,CAAC,sBAAD,CAArB;;AACA,IAAME,SAAS,GAAGF,OAAO,CAAC,eAAD,CAAzB;;AAEA,SAASG,MAAT,CAAgBC,WAAhB,EAA6BC,UAA7B,EAAyCC,IAAzC,EAA+CC,YAA/C,EAA6D;AAC3D,MAAMC,KAAK,GAAGH,UAAU,CAACC,IAAD,CAAxB;;AACA,MAAIE,KAAK,KAAKC,SAAd,EAAyB;AACvBL,IAAAA,WAAW,CAACE,IAAD,CAAX,GAAoBE,KAApB;AACD,GAFD,MAEO,IAAID,YAAY,KAAKE,SAArB,EAAgC;AACrCL,IAAAA,WAAW,CAACE,IAAD,CAAX,GAAoBC,YAApB;AACD;AACF;;AACD,SAASG,SAAT,CAAmBF,KAAnB,EAA0B;AACxB,UAAQA,KAAR;AACE,SAAK,GAAL;AACA,SAAK,MAAL;AACE,aAAO,IAAP;;AACF;AACE,aAAO,KAAP;AALJ;AAOD;;AACD,SAASG,UAAT,CAAoBP,WAApB,EAAiCC,UAAjC,EAA6CC,IAA7C,EAAmDC,YAAnD,EAAiE;AAC/D,MAAMC,KAAK,GAAGH,UAAU,CAACC,IAAD,CAAxB;;AACA,MAAIE,KAAK,KAAKC,SAAd,EAAyB;AACvBL,IAAAA,WAAW,CAACE,IAAD,CAAX,GAAoBI,SAAS,CAACF,KAAD,CAA7B;AACD,GAFD,MAEO,IAAID,YAAY,KAAKE,SAArB,EAAgC;AACrCL,IAAAA,WAAW,CAACE,IAAD,CAAX,GAAoBC,YAApB;AACD;AACF;;IAEKK,oB;;;;;;;;;;;;;2BAKGC,S,EAAWC,K,EAAO;AACvB,UAAMC,KAAK,GAAGD,KAAK,IAAIE,MAAM,CAACC,IAAP,CAAYH,KAAZ,EAAmBI,MAA1C;;AACA,UAAIH,KAAJ,EAAW;AACTF,QAAAA,SAAS,CAACM,QAAV,CAAmB,iBAAnB,EAAsC;AAACJ,UAAAA,KAAK,EAALA;AAAD,SAAtC;;AAEAhB,QAAAA,CAAC,CAACqB,IAAF,CAAON,KAAP,EAAc,UAACN,KAAD,EAAQa,OAAR,EAAoB;AAChCR,UAAAA,SAAS,CAACM,QAAV,CAAmB,gBAAnB;;AACA,cAAIX,KAAK,CAACc,IAAN,KAAe,KAAnB,EAA0B;AACxBT,YAAAA,SAAS,CAACU,YAAV,CAAuB,MAAvB,EAA+Bf,KAAK,CAACc,IAArC;;AAEA,gBAAId,KAAK,CAACgB,QAAN,IAAkBhB,KAAK,CAACc,IAAN,KAAe,MAAjC,IAA2Cd,KAAK,CAACgB,QAAN,KAAmB,SAAlE,EAA6E;AAC3EX,cAAAA,SAAS,CAACU,YAAV,CAAuB,UAAvB,EAAmCf,KAAK,CAACgB,QAAzC;AACD;;AACD,gBAAIhB,KAAK,CAACiB,UAAV,EAAsB;AACpBZ,cAAAA,SAAS,CAACU,YAAV,CAAuB,YAAvB,EAAqC,GAArC;AACD;AACF;;AACD,cAAIf,KAAK,CAACkB,gBAAV,EAA4B;AAC1Bb,YAAAA,SAAS,CAACU,YAAV,CAAuB,kBAAvB,EAA2C,GAA3C;AACD;;AACD,cAAIf,KAAK,CAACmB,WAAV,EAAuB;AACrBd,YAAAA,SAAS,CAACU,YAAV,CAAuB,aAAvB,EAAsCf,KAAK,CAACmB,WAA5C;AACD;;AACD,cAAInB,KAAK,CAACoB,MAAV,EAAkB;AAChBf,YAAAA,SAAS,CAACU,YAAV,CAAuB,QAAvB,EAAiCf,KAAK,CAACoB,MAAvC;AACD;;AACD,cAAIpB,KAAK,CAACqB,gBAAV,EAA4B;AAC1BhB,YAAAA,SAAS,CAACU,YAAV,CAAuB,kBAAvB,EAA2C,GAA3C;AACD;;AACD,cAAIf,KAAK,CAACsB,UAAV,EAAsB;AACpBjB,YAAAA,SAAS,CAACU,YAAV,CAAuB,YAAvB,EAAqCf,KAAK,CAACsB,UAA3C;AACD;;AACD,cAAItB,KAAK,CAACuB,UAAV,EAAsB;AACpBlB,YAAAA,SAAS,CAACU,YAAV,CAAuB,YAAvB,EAAqCf,KAAK,CAACuB,UAA3C;AACD;;AACD,cAAIvB,KAAK,CAACwB,KAAV,EAAiB;AACfnB,YAAAA,SAAS,CAACU,YAAV,CAAuB,OAAvB,EAAgCf,KAAK,CAACwB,KAAtC;AACD;;AACDnB,UAAAA,SAAS,CAACU,YAAV,CAAuB,OAAvB,EAAgCF,OAAhC;AACA,WAACb,KAAK,CAACyB,QAAN,IAAkB,EAAnB,EAAuBC,OAAvB,CAA+B,UAACC,OAAD,EAAUC,KAAV,EAAoB;AACjDvB,YAAAA,SAAS,CAACM,QAAV,kBAA6BiB,KAAK,GAAG,CAArC;;AACA,gBAAI5B,KAAK,CAACc,IAAN,KAAe,MAAnB,EAA2B;AACzBT,cAAAA,SAAS,CAACwB,SAAV,CAAoBpC,KAAK,CAACqC,WAAN,CAAkBH,OAAlB,CAApB;AACD,aAFD,MAEO;AACLtB,cAAAA,SAAS,CAACwB,SAAV,CAAoBF,OAApB;AACD;;AACDtB,YAAAA,SAAS,CAAC0B,SAAV;AACD,WARD;AASA1B,UAAAA,SAAS,CAAC0B,SAAV;AACD,SA5CD;;AA6CA1B,QAAAA,SAAS,CAAC0B,SAAV;AACD;AACF;;;8BAESC,I,EAAM;AACd,cAAQA,IAAI,CAAClC,IAAb;AACE,aAAK,iBAAL;AACE,eAAKQ,KAAL,GAAa,EAAb;AACA,iBAAO,IAAP;;AAEF,aAAK,gBAAL;AAAuB;AACrB,iBAAK2B,QAAL,GAAgBD,IAAI,CAACnC,UAAL,CAAgBqC,KAAhC;AACA,gBAAMtC,WAAW,GAAGoC,IAAI,CAACnC,UAAL,CAAgBiB,IAAhB,GAChB;AACAA,cAAAA,IAAI,EAAEkB,IAAI,CAACnC,UAAL,CAAgBiB,IADtB;AAEAW,cAAAA,QAAQ,EAAE;AAFV,aADgB,GAKhB;AACAX,cAAAA,IAAI,EAAE;AADN,aALJ;;AASA,gBAAIkB,IAAI,CAACnC,UAAL,CAAgBiB,IAApB,EAA0B;AACxBX,cAAAA,UAAU,CAACP,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,YAA/B,CAAV;AACD;;AACDM,YAAAA,UAAU,CAACP,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,kBAA/B,CAAV;AACAM,YAAAA,UAAU,CAACP,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,kBAA/B,CAAV;;AAEA,oBAAQD,WAAW,CAACkB,IAApB;AACE,mBAAK,KAAL;AACA,mBAAK,MAAL;AACA,mBAAK,QAAL;AACE;;AACF;AACEnB,gBAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,UAA/B,EAA2C,SAA3C,CAAN;AACA;AAPJ;;AASAF,YAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,aAA/B,CAAN;AACAF,YAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,QAA/B,CAAN;AACAF,YAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,YAA/B,CAAN;AACAF,YAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,YAA/B,CAAN;AACAF,YAAAA,MAAM,CAACC,WAAD,EAAcoC,IAAI,CAACnC,UAAnB,EAA+B,OAA/B,CAAN;AAEA,iBAAKsC,YAAL,GAAoBvC,WAApB;AACA,mBAAO,IAAP;AACD;;AAED,aAAK,UAAL;AACA,aAAK,UAAL;AACE,eAAKwC,QAAL,GAAgB,EAAhB;AACA,iBAAO,IAAP;;AAEF;AACE,iBAAO,KAAP;AA/CJ;AAiDD;;;8BAESC,I,EAAM;AACd,WAAKD,QAAL,CAAcE,IAAd,CAAmBD,IAAnB;AACD;;;+BAEUvC,I,EAAM;AACf,cAAQA,IAAR;AACE,aAAK,iBAAL;AACE,iBAAO,KAAP;;AACF,aAAK,gBAAL;AACE,cAAI,CAAC,KAAKqC,YAAL,CAAkBV,QAAnB,IAA+B,CAAC,KAAKU,YAAL,CAAkBV,QAAlB,CAA2Bf,MAA/D,EAAuE;AACrE,mBAAO,KAAKyB,YAAL,CAAkBV,QAAzB;AACA,mBAAO,KAAKU,YAAL,CAAkBnB,QAAzB;AACD;;AACD,eAAKV,KAAL,CAAW,KAAK2B,QAAhB,IAA4B,KAAKE,YAAjC;AACA,iBAAO,IAAP;;AACF,aAAK,UAAL;AACA,aAAK,UAAL;AAAiB;AACf,gBAAIR,OAAO,GAAG,KAAKS,QAAL,CAAcG,IAAd,CAAmB,EAAnB,CAAd;;AACA,oBAAQ,KAAKJ,YAAL,CAAkBrB,IAA1B;AACE,mBAAK,OAAL;AACA,mBAAK,YAAL;AACEa,gBAAAA,OAAO,GAAGa,QAAQ,CAACb,OAAD,EAAU,EAAV,CAAlB;AACA;;AACF,mBAAK,SAAL;AACEA,gBAAAA,OAAO,GAAGc,UAAU,CAACd,OAAD,CAApB;AACA;;AACF,mBAAK,MAAL;AACEA,gBAAAA,OAAO,GAAGlC,KAAK,CAACiD,WAAN,CAAkBD,UAAU,CAACd,OAAD,CAA5B,CAAV;AACA;;AACF;AACE;AAZJ;;AAcA,iBAAKQ,YAAL,CAAkBV,QAAlB,CAA2Ba,IAA3B,CAAgCX,OAAhC;;AACA,mBAAO,IAAP;AACD;;AACD;AACE,iBAAO,IAAP;AA/BJ;AAiCD;;;wBApJS;AACR,aAAO,iBAAP;AACD;;;;EAHgCjC,S;;AAwJnCiD,MAAM,CAACC,OAAP,GAAiBxC,oBAAjB","sourcesContent":["const _ = require('../../../utils/under-dash');\r\nconst utils = require('../../../utils/utils');\r\nconst BaseXform = require('../base-xform');\r\n\r\nfunction assign(definedName, attributes, name, defaultValue) {\r\n  const value = attributes[name];\r\n  if (value !== undefined) {\r\n    definedName[name] = value;\r\n  } else if (defaultValue !== undefined) {\r\n    definedName[name] = defaultValue;\r\n  }\r\n}\r\nfunction parseBool(value) {\r\n  switch (value) {\r\n    case '1':\r\n    case 'true':\r\n      return true;\r\n    default:\r\n      return false;\r\n  }\r\n}\r\nfunction assignBool(definedName, attributes, name, defaultValue) {\r\n  const value = attributes[name];\r\n  if (value !== undefined) {\r\n    definedName[name] = parseBool(value);\r\n  } else if (defaultValue !== undefined) {\r\n    definedName[name] = defaultValue;\r\n  }\r\n}\r\n\r\nclass DataValidationsXform extends BaseXform {\r\n  get tag() {\r\n    return 'dataValidations';\r\n  }\r\n\r\n  render(xmlStream, model) {\r\n    const count = model && Object.keys(model).length;\r\n    if (count) {\r\n      xmlStream.openNode('dataValidations', {count});\r\n\r\n      _.each(model, (value, address) => {\r\n        xmlStream.openNode('dataValidation');\r\n        if (value.type !== 'any') {\r\n          xmlStream.addAttribute('type', value.type);\r\n\r\n          if (value.operator && value.type !== 'list' && value.operator !== 'between') {\r\n            xmlStream.addAttribute('operator', value.operator);\r\n          }\r\n          if (value.allowBlank) {\r\n            xmlStream.addAttribute('allowBlank', '1');\r\n          }\r\n        }\r\n        if (value.showInputMessage) {\r\n          xmlStream.addAttribute('showInputMessage', '1');\r\n        }\r\n        if (value.promptTitle) {\r\n          xmlStream.addAttribute('promptTitle', value.promptTitle);\r\n        }\r\n        if (value.prompt) {\r\n          xmlStream.addAttribute('prompt', value.prompt);\r\n        }\r\n        if (value.showErrorMessage) {\r\n          xmlStream.addAttribute('showErrorMessage', '1');\r\n        }\r\n        if (value.errorStyle) {\r\n          xmlStream.addAttribute('errorStyle', value.errorStyle);\r\n        }\r\n        if (value.errorTitle) {\r\n          xmlStream.addAttribute('errorTitle', value.errorTitle);\r\n        }\r\n        if (value.error) {\r\n          xmlStream.addAttribute('error', value.error);\r\n        }\r\n        xmlStream.addAttribute('sqref', address);\r\n        (value.formulae || []).forEach((formula, index) => {\r\n          xmlStream.openNode(`formula${index + 1}`);\r\n          if (value.type === 'date') {\r\n            xmlStream.writeText(utils.dateToExcel(formula));\r\n          } else {\r\n            xmlStream.writeText(formula);\r\n          }\r\n          xmlStream.closeNode();\r\n        });\r\n        xmlStream.closeNode();\r\n      });\r\n      xmlStream.closeNode();\r\n    }\r\n  }\r\n\r\n  parseOpen(node) {\r\n    switch (node.name) {\r\n      case 'dataValidations':\r\n        this.model = {};\r\n        return true;\r\n\r\n      case 'dataValidation': {\r\n        this._address = node.attributes.sqref;\r\n        const definedName = node.attributes.type\r\n          ? {\r\n            type: node.attributes.type,\r\n            formulae: [],\r\n          }\r\n          : {\r\n            type: 'any',\r\n          };\r\n\r\n        if (node.attributes.type) {\r\n          assignBool(definedName, node.attributes, 'allowBlank');\r\n        }\r\n        assignBool(definedName, node.attributes, 'showInputMessage');\r\n        assignBool(definedName, node.attributes, 'showErrorMessage');\r\n\r\n        switch (definedName.type) {\r\n          case 'any':\r\n          case 'list':\r\n          case 'custom':\r\n            break;\r\n          default:\r\n            assign(definedName, node.attributes, 'operator', 'between');\r\n            break;\r\n        }\r\n        assign(definedName, node.attributes, 'promptTitle');\r\n        assign(definedName, node.attributes, 'prompt');\r\n        assign(definedName, node.attributes, 'errorStyle');\r\n        assign(definedName, node.attributes, 'errorTitle');\r\n        assign(definedName, node.attributes, 'error');\r\n\r\n        this._definedName = definedName;\r\n        return true;\r\n      }\r\n\r\n      case 'formula1':\r\n      case 'formula2':\r\n        this._formula = [];\r\n        return true;\r\n\r\n      default:\r\n        return false;\r\n    }\r\n  }\r\n\r\n  parseText(text) {\r\n    this._formula.push(text);\r\n  }\r\n\r\n  parseClose(name) {\r\n    switch (name) {\r\n      case 'dataValidations':\r\n        return false;\r\n      case 'dataValidation':\r\n        if (!this._definedName.formulae || !this._definedName.formulae.length) {\r\n          delete this._definedName.formulae;\r\n          delete this._definedName.operator;\r\n        }\r\n        this.model[this._address] = this._definedName;\r\n        return true;\r\n      case 'formula1':\r\n      case 'formula2': {\r\n        let formula = this._formula.join('');\r\n        switch (this._definedName.type) {\r\n          case 'whole':\r\n          case 'textLength':\r\n            formula = parseInt(formula, 10);\r\n            break;\r\n          case 'decimal':\r\n            formula = parseFloat(formula);\r\n            break;\r\n          case 'date':\r\n            formula = utils.excelToDate(parseFloat(formula));\r\n            break;\r\n          default:\r\n            break;\r\n        }\r\n        this._definedName.formulae.push(formula);\r\n        return true;\r\n      }\r\n      default:\r\n        return true;\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = DataValidationsXform;\r\n"],"file":"data-validations-xform.js"}