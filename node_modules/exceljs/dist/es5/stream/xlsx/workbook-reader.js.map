{"version":3,"sources":["../../../../lib/stream/xlsx/workbook-reader.js"],"names":["fs","require","events","Stream","unzip","Sax","tmp","utils","FlowControl","StyleManager","WorkbookPropertiesManager","WorksheetReader","HyperlinkReader","setGracefulCleanup","WorkbookReader","module","exports","options","styles","init","properties","worksheetReaders","hyperlinkReaders","readers","atEnd","waitingWorkSheets","tempFileCleanupCallbacks","inherits","EventEmitter","_getStream","input","Readable","createReadStream","Error","flowControl","_flowControl","entries","sharedStrings","hyperlinks","worksheets","read","stream","zip","Parse","on","entry","match","sheetNo","path","autodrain","_parseWorkbook","_parseSharedStrings","_parseStyles","_parseWorksheet","file","err","fd","cleanupCallback","tempStream","createWriteStream","push","pipe","_parseHyperlinks","length","currentBook","processBooks","worksheetInfo","worksheet","forEach","cb","emit","setImmediate","_emitEntry","payload","type","parseStream","self","parser","createStream","inT","t","index","node","name","text","error","_getReader","Type","collection","reader","id","worksheetReader","hyperlinksReader"],"mappings":"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","sourcesContent":["'use strict';\r\n\r\nconst fs = require('fs');\r\nconst events = require('events');\r\nconst Stream = require('stream');\r\nconst unzip = require('unzipper');\r\nconst Sax = require('sax');\r\nconst tmp = require('tmp');\r\n\r\nconst utils = require('../../utils/utils');\r\nconst FlowControl = require('../../utils/flow-control');\r\n\r\nconst StyleManager = require('../../xlsx/xform/style/styles-xform');\r\nconst WorkbookPropertiesManager = require('../../xlsx/xform/book/workbook-properties-xform');\r\n\r\nconst WorksheetReader = require('./worksheet-reader');\r\nconst HyperlinkReader = require('./hyperlink-reader');\r\n\r\ntmp.setGracefulCleanup();\r\n\r\nconst WorkbookReader = (module.exports = function(options) {\r\n  this.options = options = options || {};\r\n\r\n  this.styles = new StyleManager();\r\n  this.styles.init();\r\n\r\n  this.properties = new WorkbookPropertiesManager();\r\n\r\n  // worksheet readers, indexed by sheetNo\r\n  this.worksheetReaders = {};\r\n\r\n  // hyperlink readers, indexed by sheetNo\r\n  this.hyperlinkReaders = {};\r\n\r\n  // count the open readers\r\n  this.readers = 0;\r\n\r\n  // end of stream check\r\n  this.atEnd = false;\r\n\r\n  // worksheets, deferred for parsing after shared strings reading\r\n  this.waitingWorkSheets = [];\r\n\r\n  // callbacks for temp files cleanup\r\n  this.tempFileCleanupCallbacks = [];\r\n});\r\n\r\nutils.inherits(WorkbookReader, events.EventEmitter, {\r\n  _getStream(input) {\r\n    if (input instanceof Stream.Readable) {\r\n      return input;\r\n    }\r\n    if (typeof input === 'string') {\r\n      return fs.createReadStream(input);\r\n    }\r\n    throw new Error('Could not recognise input');\r\n  },\r\n\r\n  get flowControl() {\r\n    if (!this._flowControl) {\r\n      this._flowControl = new FlowControl(this.options);\r\n    }\r\n    return this._flowControl;\r\n  },\r\n\r\n  options: {\r\n    entries: ['emit'],\r\n    sharedStrings: ['cache', 'emit'],\r\n    styles: ['cache'],\r\n    hyperlinks: ['cache', 'emit'],\r\n    worksheets: ['emit'],\r\n  },\r\n  read(input, options) {\r\n    const stream = (this.stream = this._getStream(input));\r\n    const zip = (this.zip = unzip.Parse());\r\n\r\n    zip.on('entry', entry => {\r\n      let match;\r\n      let sheetNo;\r\n      switch (entry.path) {\r\n        case '_rels/.rels':\r\n        case 'xl/_rels/workbook.xml.rels':\r\n          entry.autodrain();\r\n          break;\r\n        case 'xl/workbook.xml':\r\n          this._parseWorkbook(entry, options);\r\n          break;\r\n        case 'xl/sharedStrings.xml':\r\n          this._parseSharedStrings(entry, options);\r\n          break;\r\n        case 'xl/styles.xml':\r\n          this._parseStyles(entry, options);\r\n          break;\r\n        default:\r\n          if (entry.path.match(/xl\\/worksheets\\/sheet\\d+[.]xml/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/sheet(\\d+)[.]xml/);\r\n            sheetNo = match[1];\r\n            if (this.sharedStrings) {\r\n              this._parseWorksheet(entry, sheetNo, options);\r\n            } else {\r\n              // create temp file for each worksheet\r\n              tmp.file((err, path, fd, cleanupCallback) => {\r\n                if (err) throw err;\r\n\r\n                const tempStream = fs.createWriteStream(path);\r\n\r\n                this.waitingWorkSheets.push({ sheetNo, options, path });\r\n                entry.pipe(tempStream);\r\n\r\n                this.tempFileCleanupCallbacks.push(cleanupCallback);\r\n              });\r\n            }\r\n          } else if (entry.path.match(/xl\\/worksheets\\/_rels\\/sheet\\d+[.]xml.rels/)) {\r\n            match = entry.path.match(/xl\\/worksheets\\/_rels\\/sheet(\\d+)[.]xml.rels/);\r\n            sheetNo = match[1];\r\n            this._parseHyperlinks(entry, sheetNo, options);\r\n          } else {\r\n            entry.autodrain();\r\n          }\r\n          break;\r\n      }\r\n    });\r\n\r\n    zip.on('close', () => {\r\n      if (this.waitingWorkSheets.length) {\r\n        let currentBook = 0;\r\n\r\n        const processBooks = () => {\r\n          const worksheetInfo = this.waitingWorkSheets[currentBook];\r\n          const entry = fs.createReadStream(worksheetInfo.path);\r\n\r\n          const {sheetNo} = worksheetInfo;\r\n          const worksheet = this._parseWorksheet(\r\n            entry,\r\n            sheetNo,\r\n            worksheetInfo.options\r\n          );\r\n\r\n          worksheet.on('finished', () => {\r\n            ++currentBook;\r\n            if (currentBook === this.waitingWorkSheets.length) {\r\n              // temp files cleaning up\r\n              this.tempFileCleanupCallbacks.forEach(cb => {\r\n                cb();\r\n              });\r\n\r\n              this.tempFileCleanupCallbacks = [];\r\n\r\n              this.emit('end');\r\n              this.atEnd = true;\r\n              if (!this.readers) {\r\n                this.emit('finished');\r\n              }\r\n            } else {\r\n              setImmediate(processBooks);\r\n            }\r\n          });\r\n        };\r\n        setImmediate(processBooks);\r\n      } else {\r\n        this.emit('end');\r\n        this.atEnd = true;\r\n        if (!this.readers) {\r\n          this.emit('finished');\r\n        }\r\n      }\r\n    });\r\n\r\n    zip.on('error', err => {\r\n      this.emit('error', err);\r\n    });\r\n\r\n    // Pipe stream into top flow-control\r\n    // this.flowControl.pipe(zip);\r\n    stream.pipe(zip);\r\n  },\r\n  _emitEntry(options, payload) {\r\n    if (options.entries === 'emit') {\r\n      this.emit('entry', payload);\r\n    }\r\n  },\r\n  _parseWorkbook(entry, options) {\r\n    this._emitEntry(options, { type: 'workbook' });\r\n    this.properties.parseStream(entry);\r\n  },\r\n  _parseSharedStrings(entry, options) {\r\n    this._emitEntry(options, { type: 'shared-strings' });\r\n    const self = this;\r\n    let sharedStrings = null;\r\n    switch (options.sharedStrings) {\r\n      case 'cache':\r\n        sharedStrings = this.sharedStrings = [];\r\n        break;\r\n      case 'emit':\r\n        break;\r\n      default:\r\n        entry.autodrain();\r\n        return;\r\n    }\r\n\r\n    const parser = Sax.createStream(true, {});\r\n    let inT = false;\r\n    let t = null;\r\n    let index = 0;\r\n    parser.on('opentag', node => {\r\n      if (node.name === 't') {\r\n        t = null;\r\n        inT = true;\r\n      }\r\n    });\r\n    parser.on('closetag', name => {\r\n      if (inT && name === 't') {\r\n        if (sharedStrings) {\r\n          sharedStrings.push(t);\r\n        } else {\r\n          self.emit('shared-string', { index: index++, text: t });\r\n        }\r\n        t = null;\r\n      }\r\n    });\r\n    parser.on('text', text => {\r\n      t = t ? t + text : text;\r\n    });\r\n    parser.on('error', error => {\r\n      self.emit('error', error);\r\n    });\r\n    entry.pipe(parser);\r\n  },\r\n  _parseStyles(entry, options) {\r\n    this._emitEntry(options, { type: 'styles' });\r\n    if (options.styles !== 'cache') {\r\n      entry.autodrain();\r\n      return;\r\n    }\r\n    this.styles = new StyleManager();\r\n    this.styles.parseStream(entry);\r\n  },\r\n  _getReader(Type, collection, sheetNo) {\r\n    const self = this;\r\n    let reader = collection[sheetNo];\r\n    if (!reader) {\r\n      reader = new Type(this, sheetNo);\r\n      self.readers++;\r\n      reader.on('finished', () => {\r\n        if (!--self.readers) {\r\n          if (self.atEnd) {\r\n            self.emit('finished');\r\n          }\r\n        }\r\n      });\r\n      collection[sheetNo] = reader;\r\n    }\r\n    return reader;\r\n  },\r\n  _parseWorksheet(entry, sheetNo, options) {\r\n    this._emitEntry(options, { type: 'worksheet', id: sheetNo });\r\n    const worksheetReader = this._getReader(WorksheetReader, this.worksheetReaders, sheetNo);\r\n    if (options.worksheets === 'emit') {\r\n      this.emit('worksheet', worksheetReader);\r\n    }\r\n    worksheetReader.read(entry, options, this.hyperlinkReaders[sheetNo]);\r\n    return worksheetReader;\r\n  },\r\n  _parseHyperlinks(entry, sheetNo, options) {\r\n    this._emitEntry(options, { type: 'hyerlinks', id: sheetNo });\r\n    const hyperlinksReader = this._getReader(HyperlinkReader, this.hyperlinkReaders, sheetNo);\r\n    if (options.hyperlinks === 'emit') {\r\n      this.emit('hyperlinks', hyperlinksReader);\r\n    }\r\n    hyperlinksReader.read(entry, options);\r\n  },\r\n});\r\n"],"file":"workbook-reader.js"}